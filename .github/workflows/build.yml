name: pw2-ipk-a53-min

on:
  workflow_dispatch:
    inputs:
      passwall2_tag:
        description: "Empty = Latest release tag"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: deps
        shell: bash
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk gcc-multilib gettext \
            git libncurses5-dev libssl-dev python3 python3-distutils rsync unzip zlib1g-dev \
            file wget curl ca-certificates jq xz-utils zip

      - name: tag
        id: rel
        shell: bash
        run: |
          set -e
          IN="${{ github.event.inputs.passwall2_tag }}"
          if [ -n "$IN" ]; then
            echo "tag=$IN" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          TAG="$(curl -fsSL https://api.github.com/repos/Openwrt-Passwall/openwrt-passwall2/releases/latest | jq -r .tag_name)"
          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            echo "cannot get latest tag" >&2
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: clone
        shell: bash
        run: |
          set -e
          git clone --depth 1 --branch v21.02.7 https://github.com/immortalwrt/immortalwrt.git openwrt

      - name: feeds
        shell: bash
        run: |
          set -e
          cd openwrt
          echo "src-git passwall2 https://github.com/Openwrt-Passwall/openwrt-passwall2.git;main" >> feeds.conf.default
          echo "src-git passwall_packages https://github.com/Openwrt-Passwall/openwrt-passwall-packages.git;main" >> feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          cd feeds/passwall2
          git fetch --tags --force
          git checkout -f "${{ steps.rel.outputs.tag }}"

      - name: config
        shell: bash
        run: |
          set -e
          cd openwrt
          : > .config
          echo "CONFIG_TARGET_mediatek=y" >> .config
          echo "CONFIG_TARGET_mediatek_mt7622=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2=m" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-passwall2-zh-cn=m" >> .config
          make defconfig

      - name: toolchain
        shell: bash
        run: |
          set -e
          cd openwrt
          make tools/install -j"$(nproc)" V=s
          make toolchain/install -j1 V=s

      - name: build
        shell: bash
        run: |
          set -e
          set -x
          cd openwrt

          if [ ! -d package/feeds/passwall2/luci-app-passwall2 ]; then
            echo "Missing: luci-app-passwall2" >&2
            find package/feeds -maxdepth 4 -type d -name 'luci-app-passwall2' -print || true
            exit 1
          fi

          I18N_DIR="$(find package/feeds -maxdepth 5 -type d -name 'luci-i18n-passwall2-zh-cn' | head -n 1 || true)"
          if [ -z "$I18N_DIR" ]; then
            echo "Missing: luci-i18n-passwall2-zh-cn" >&2
            echo "Found luci-i18n-passwall2*:" >&2
            find package/feeds -maxdepth 6 -type d -name 'luci-i18n-passwall2*' -print || true
            exit 1
          fi

          make package/feeds/passwall2/luci-app-passwall2/compile -j"$(nproc)" V=s
          make "${I18N_DIR}/compile" -j"$(nproc)" V=s

      - name: pack
        shell: bash
        run: |
          set -e
          cd openwrt
          mkdir -p out/luci
          find bin/packages -type f -name "luci-app-passwall2_*.ipk" -exec cp -f {} out/luci/ \;
          find bin/packages -type f -name "luci-i18n-passwall2-zh-cn_*.ipk" -exec cp -f {} out/luci/ \;
          (cd out && zip -9 -r pw2_luci_ipk_aarch64_cortex-a53.zip luci)

      - name: release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ipk-${{ steps.rel.outputs.tag }}-a53-min
          name: ipk-${{ steps.rel.outputs.tag }}-a53-min
          files: |
            openwrt/out/pw2_luci_ipk_aarch64_cortex-a53.zip
