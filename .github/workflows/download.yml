name: Download Passwall2 IPKs

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  TZ: Asia/Shanghai  # ç¡®ä¿ Release æ—¶é—´æ˜¯åŒ—äº¬æ—¶é—´

jobs:
  download_strict:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install requests

      - name: Generate Date Tag
        id: tag
        run: |
          # ç”Ÿæˆæ—¶é—´æ ‡ç­¾ï¼Œä¾‹å¦‚: 2026.02.08-1430
          echo "date=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Run Downloader
        run: |
          mkdir -p output
          
          # ç¼–å†™ Python ä¸‹è½½è„šæœ¬
          cat << 'EOF' > downloader.py
          import requests
          import os
          import sys
          import gzip

          # ================== ä¸¥æ ¼é…ç½®åŒºåŸŸ ==================
          # ä»…ä½¿ç”¨ Moetayuko SourceForge 21.02 æº
          BASE_URL = "https://downloads.sourceforge.net/project/openwrt-passwall-build/releases/packages-21.02/aarch64_cortex-a53/passwall_packages"
          
          # ä¼ªè£… Header
          HEADERS = {'User-Agent': 'Wget/1.21.2 (linux-gnu)', 'Accept': '*/*'}

          # ä¸¥æ ¼é»‘åå• (é‡åˆ°å³è·³è¿‡)
          EXCLUDE_KEYWORDS = [
              "shadowsocksr-libev-ssr-nat",
              "simple-obfs-server"
          ]
          # =================================================

          def get_index_content(url):
              print(f"ğŸ”— è¿æ¥æº: {url}")
              try:
                  # å°è¯•ä¸‹è½½ Packages çº¯æ–‡æœ¬
                  r = requests.get(f"{url}/Packages", headers=HEADERS, timeout=30, allow_redirects=True)
                  if r.status_code == 404:
                      print("   Packages æ–‡æœ¬æœªæ‰¾åˆ°ï¼Œå°è¯• .gz ...")
                      r = requests.get(f"{url}/Packages.gz", headers=HEADERS, timeout=30, allow_redirects=True)
                  
                  if r.status_code == 200:
                      # å¤„ç† gzip
                      content = r.content
                      if url.endswith('.gz') or content[:2] == b'\x1f\x8b':
                          return gzip.decompress(content).decode('utf-8', errors='ignore')
                      return content.decode('utf-8', errors='ignore')
                  return None
              except Exception as e:
                  print(f"âŒ è¿æ¥å¤±è´¥: {e}")
                  return None

          def parse_filenames(content):
              files = []
              if not content: return files
              for line in content.splitlines():
                  line = line.strip()
                  # ä»ç´¢å¼•ä¸­æå–æ‰€æœ‰ Filename
                  if line.startswith("Filename:"):
                      filename = line.split(":", 1)[1].strip()
                      if filename.endswith(".ipk"):
                          files.append(filename)
              # å»é‡æ’åº
              return sorted(list(set(files)))

          # --- ä¸»ç¨‹åºå¼€å§‹ ---
          
          # 1. è·å–æ–‡ä»¶åˆ—è¡¨
          print("1. è·å–è½¯ä»¶æºç´¢å¼•...")
          content = get_index_content(BASE_URL)
          
          if not content:
              print("âŒ ä¸¥é‡é”™è¯¯: æ— æ³•ä¸‹è½½ç´¢å¼•æ–‡ä»¶ã€‚")
              sys.exit(1)
              
          if "<html" in content.lower():
              print("âŒ é”™è¯¯: ä¸‹è½½åˆ°çš„æ˜¯ HTML é¡µé¢ï¼Œéç´¢å¼•æ–‡ä»¶ã€‚")
              sys.exit(1)

          all_files = parse_filenames(content)
          print(f"âœ… ç´¢å¼•è§£ææˆåŠŸï¼Œæºä¸­å…±æœ‰ {len(all_files)} ä¸ª IPK æ–‡ä»¶ã€‚")

          # 2. è¿‡æ»¤ä¸ä¸‹è½½
          downloaded_count = 0
          
          print("\n2. å¼€å§‹æ‰¹é‡ä¸‹è½½...")
          for i, filename in enumerate(all_files, 1):
              # --- é»‘åå•æ£€æŸ¥ ---
              is_excluded = False
              for keyword in EXCLUDE_KEYWORDS:
                  if keyword in filename:
                      print(f"[{i}/{len(all_files)}] ğŸš« å·²å±è”½: {filename}")
                      is_excluded = True
                      break
              if is_excluded:
                  continue
              
              # --- ä¸‹è½½é€»è¾‘ ---
              file_url = f"{BASE_URL}/{filename}"
              save_path = f"output/{filename}"
              
              print(f"[{i}/{len(all_files)}] â¬‡ï¸ ä¸‹è½½: {filename}")
              
              try:
                  with requests.get(file_url, headers=HEADERS, stream=True, timeout=60) as r:
                      r.raise_for_status()
                      with open(save_path, 'wb') as f:
                          for chunk in r.iter_content(chunk_size=8192):
                              f.write(chunk)
                  
                  if os.path.getsize(save_path) > 1024:
                      downloaded_count += 1
                  else:
                      print("      âš ï¸ æ–‡ä»¶è¿‡å°ï¼Œåˆ é™¤")
                      if os.path.exists(save_path): os.remove(save_path)
              except Exception as e:
                  print(f"      âŒ ä¸‹è½½å¼‚å¸¸: {e}")

          print(f"\nğŸ‰ ä»»åŠ¡å®Œæˆï¼å®é™…ä¸‹è½½ {downloaded_count} ä¸ªæ–‡ä»¶ã€‚")
          if downloaded_count == 0:
              sys.exit(1)
          EOF
          
          # æ‰§è¡Œè„šæœ¬
          python3 downloader.py

      - name: Create Zip for Release
        run: |
          cd output
          # ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„å‘½åæ‰“åŒ…
          zip -r ../passwall_packages_arch64_cortex-a53-\(ipq60xx\).zip .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.date }}
          name: Auto Build ${{ steps.tag.outputs.date }}
          body: |
            âœ… Passwall2 ä¾èµ–åŒ…è‡ªåŠ¨æå– (SourceForge 21.02 Only)
            
            **æ„å»ºä¿¡æ¯ï¼š**
            - æ—¶é—´: ${{ steps.tag.outputs.date }} (åŒ—äº¬æ—¶é—´)
            - æ¶æ„: aarch64_cortex-a53 (ipq60xx)
            - æ¥æº: Moetayuko (SourceForge)
            
            **å·²æ’é™¤:**
            - `shadowsocksr-libev-ssr-nat`
            - `simple-obfs-server`
            
            â¬‡ï¸ **ç‚¹å‡»ä¸‹æ–¹ zip ä¸‹è½½**
          files: passwall_packages_arch64_cortex-a53-(ipq60xx).zip
