name: Download Passwall2 IPKs (SourceForge 21.02 Direct)

on:
  workflow_dispatch:

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download from SourceForge
        run: |
          mkdir -p output
          cd output
          
          # --------------------------------------------------------------------------------
          # 核心修正：
          # 1. 使用 SourceForge 21.02 源 (IPK格式)
          # 2. 锁定架构 aarch64_cortex-a53 (ipq60xx)
          # --------------------------------------------------------------------------------
          BASE_URL="https://downloads.sourceforge.net/project/openwrt-passwall-build/releases/packages-21.02/aarch64_cortex-a53/passwall_packages"
          
          echo "1. 下载 Packages 索引文件 (获取真实文件名)..."
          # 使用 wget 下载索引，失败则重试
          wget -q --tries=3 --timeout=10 "$BASE_URL/Packages" -O Packages
          
          if [ ! -s Packages ]; then
             echo "::error::无法连接到 SourceForge 21.02 源，请检查网络或源地址。"
             exit 1
          fi

          echo "2. 开始精准匹配并下载..."
          
          # 绝对路径读取清单
          PACKAGE_LIST="$GITHUB_WORKSPACE/packages.txt"
          
          while IFS= read -r keyword || [ -n "$keyword" ]; do
            [[ "$keyword" =~ ^#.*$ ]] && continue
            [[ -z "$keyword" ]] && continue
            keyword=$(echo "$keyword" | tr -d '\r')
            
            echo "--- 处理: $keyword ---"
            
            # 【核心逻辑】从 Packages 文件中提取 Filename
            # 逻辑：查找 "Package: keyword" 对应的 "Filename: xxx.ipk"
            # 如果找不到完全匹配的包名，尝试模糊匹配文件名
            
            # 尝试1: 精准匹配包名 (Package: name)
            target_file=$(awk -v pkg="$keyword" 'BEGIN{RS=""; FS="\n"} $0 ~ "Package: "pkg {for(i=1;i<=NF;i++) if($i ~ /^Filename:/) {print $i; exit}}' Packages | cut -d: -f2 | tr -d ' ')
            
            # 尝试2: 如果精准匹配失败，尝试模糊匹配文件名 (Filename: ...keyword...)
            if [ -z "$target_file" ]; then
               echo "   (精准匹配失败，尝试文件名模糊搜索...)"
               target_file=$(grep "Filename:" Packages | grep "$keyword" | head -n 1 | cut -d: -f2 | tr -d ' ')
            fi
            
            if [ -n "$target_file" ]; then
              echo "   -> 锁定目标: $target_file"
              
              # 检查文件是否已下载
              if [ -f "$target_file" ]; then
                 echo "   -> 文件已存在，跳过。"
              else
                 echo "   -> 正在下载..."
                 wget -q --show-progress "$BASE_URL/$target_file" -O "$target_file"
                 
                 if [ $? -eq 0 ]; then
                    echo "   -> 成功。"
                 else
                    echo "::warning::下载失败: $target_file"
                 fi
              fi
            else
              echo "::warning::源中未找到包含 '$keyword' 的包！"
            fi
            
          done < "$PACKAGE_LIST"

          # ---------------------------------------------------------
          # 兜底：处理 shadowsocks-rust 可能的命名差异
          # ---------------------------------------------------------
          if grep -q "shadowsocks-rust" "$PACKAGE_LIST"; then
             if ! ls *shadowsocks-rust*.ipk 1> /dev/null 2>&1; then
                 echo "触发 SS-Rust 兜底下载..."
                 # 尝试下载包含 ss-local 或 ss-server 的包
                 grep "Filename: .*shadowsocks.*rust.*" Packages | cut -d: -f2 | tr -d ' ' | while read -r f; do
                    wget -q "$BASE_URL/$f" -O "$f"
                 done
             fi
          fi
          
          # 清理索引文件
          rm -f Packages

          echo "------------------------------------------------"
          echo "下载完成，清单如下："
          ls -lh *.ipk
          echo "------------------------------------------------"

      - name: Repackage
        run: |
          cd output
          if [ -z "$(ls -A .)" ]; then
             echo "::error::没有下载到任何文件！请检查 packages.txt 内容。"
             exit 1
          fi
          zip -r ../passwall_ipk_ipq60xx_ready.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: passwall_ipk_ipq60xx_ready
          path: passwall_ipk_ipq60xx_ready.zip
