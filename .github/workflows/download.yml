name: Download Passwall2 IPKs (Official GitHub Release)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download from GitHub Releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p downloads
          
          echo "1. 正在从 moetayuko 仓库下载 packages-21.02 (IPK版)..."
          
          # 使用官方 gh 命令下载，更稳更快
          # -p 指定文件名模式，只下载 aarch64 的 zip 包
          gh release download packages-21.02 \
            --repo moetayuko/openwrt-passwall-build \
            --pattern "passwall_packages_aarch64_*.zip" \
            --dir downloads

          # 检查下载结果
          ZIP_FILE=$(ls downloads/*.zip | head -n 1)
          if [ -z "$ZIP_FILE" ]; then
             echo "::error::下载失败！未找到匹配的 zip 文件。"
             exit 1
          fi
          echo "下载成功: $ZIP_FILE"

      - name: Extract and Filter
        run: |
          mkdir -p output
          
          # 获取 zip 文件路径
          ZIP_FILE=$(ls downloads/*.zip | head -n 1)
          
          echo "2. 解压文件..."
          # 解压到临时目录 extracted
          unzip -q -o "$ZIP_FILE" -d extracted
          
          echo "3. 根据 packages.txt 筛选 IPK..."
          
          # 使用绝对路径定位 packages.txt，防止路径错误
          PACKAGE_LIST="$GITHUB_WORKSPACE/packages.txt"
          
          if [ ! -f "$PACKAGE_LIST" ]; then
             echo "::error::根目录下未找到 packages.txt！"
             exit 1
          fi

          # 逐行读取清单
          while IFS= read -r keyword || [ -n "$keyword" ]; do
            # 跳过注释和空行
            [[ "$keyword" =~ ^#.*$ ]] && continue
            [[ -z "$keyword" ]] && continue
            # 清理 Windows 回车符 (CRLF -> LF)
            keyword=$(echo "$keyword" | tr -d '\r')
            
            echo "正在搜索: $keyword"
            
            # 使用 find 在解压目录(及其子目录)中查找包含关键词的 .ipk
            # -exec cp 直接复制到 output 目录
            find extracted -name "*${keyword}*.ipk" -exec cp {} output/ \;
          done < "$PACKAGE_LIST"
          
          # ---------------------------------------------------------
          # 额外兜底逻辑：处理命名不一致的情况
          # ---------------------------------------------------------
          # 如果清单里有 shadowsocks-rust，但没搜到文件（可能文件名叫 ss-rust 或其他），则暴力匹配
          if grep -q "shadowsocks-rust" "$PACKAGE_LIST"; then
             if ! ls output/*shadowsocks-rust*.ipk 1> /dev/null 2>&1; then
                 echo "触发 Shadowsocks-Rust 兜底匹配..."
                 find extracted -name "*shadowsocks-rust*.ipk" -exec cp {} output/ \;
             fi
          fi

          echo "------------------------------------------------"
          echo "筛选完成，最终文件列表 (output 目录)："
          ls -lh output/
          echo "------------------------------------------------"

      - name: Repackage
        run: |
          cd output
          # 检查目录是否为空
          if [ -z "$(ls -A .)" ]; then
             echo "::error::筛选结果为空！请检查 packages.txt 的名称是否与源文件匹配。"
             exit 1
          fi
          
          # 打包
          zip -r ../passwall_ipk_ipq60xx_ready.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: passwall_ipk_ipq60xx_ready
          path: passwall_ipk_ipq60xx_ready.zip
