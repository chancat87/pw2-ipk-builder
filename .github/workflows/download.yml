name: Download ALL Passwall2 IPKs (SourceForge Mirror)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  download_all:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install requests

      - name: Run Downloader
        run: |
          mkdir -p output
          
          # åˆ›å»ºå…¨é‡ä¸‹è½½è„šæœ¬
          cat << 'EOF' > downloader.py
          import requests
          import os
          import sys
          import gzip

          # ç›®æ ‡æºï¼šSourceForge OpenWrt 21.02 ipq60xx ä¸“ç”¨æº
          BASE_URL = "https://downloads.sourceforge.net/project/openwrt-passwall-build/releases/packages-21.02/aarch64_cortex-a53/passwall_packages"
          HEADERS = {'User-Agent': 'Wget/1.21.2 (linux-gnu)', 'Accept': '*/*'}

          # 1. è·å–ç´¢å¼• (Packages æ–‡ä»¶)
          print(f"1. è¿æ¥æº: {BASE_URL}")
          try:
              # å°è¯•ä¸‹è½½ Packages
              r = requests.get(f"{BASE_URL}/Packages", headers=HEADERS, timeout=30, allow_redirects=True)
              if r.status_code == 404:
                  print("Packages çº¯æ–‡æœ¬ä¸å­˜åœ¨ï¼Œå°è¯• Packages.gz...")
                  r = requests.get(f"{BASE_URL}/Packages.gz", headers=HEADERS, timeout=30, allow_redirects=True)
                  r.raise_for_status()
                  content = gzip.decompress(r.content).decode('utf-8', errors='ignore')
              else:
                  r.raise_for_status()
                  content = r.content.decode('utf-8', errors='ignore')
          except Exception as e:
              print(f"âŒ ç´¢å¼•ä¸‹è½½å¤±è´¥: {e}")
              sys.exit(1)

          if "<html" in content.lower():
              print("âŒ é”™è¯¯: è¢« SourceForge æ‹¦æˆªï¼Œè¿”å›äº† HTML é¡µé¢ã€‚")
              sys.exit(1)

          # 2. è§£ææ‰€æœ‰æ–‡ä»¶å
          filenames = []
          for line in content.splitlines():
              line = line.strip()
              if line.startswith("Filename:"):
                  fname = line.split(":", 1)[1].strip()
                  if fname.endswith(".ipk"):
                      filenames.append(fname)
          
          # å»é‡
          filenames = sorted(list(set(filenames)))
          total_files = len(filenames)
          print(f"âœ… ç´¢å¼•è§£ææˆåŠŸï¼Œæºä¸­å…±æœ‰ {total_files} ä¸ª IPK æ–‡ä»¶ã€‚")
          print("ğŸš€ å‡†å¤‡å…¨éƒ¨ä¸‹è½½ï¼")

          # 3. æ‰¹é‡ä¸‹è½½
          downloaded_count = 0
          
          for i, filename in enumerate(filenames, 1):
              file_url = f"{BASE_URL}/{filename}"
              save_path = f"output/{filename}"
              
              print(f"[{i}/{total_files}] ä¸‹è½½: {filename}")
              
              if os.path.exists(save_path):
                  print("   â© å·²å­˜åœ¨ï¼Œè·³è¿‡")
                  continue

              try:
                  with requests.get(file_url, headers=HEADERS, stream=True, timeout=60) as r:
                      r.raise_for_status()
                      with open(save_path, 'wb') as f:
                          for chunk in r.iter_content(chunk_size=8192):
                              f.write(chunk)
                  
                  if os.path.getsize(save_path) > 1024:
                      downloaded_count += 1
                  else:
                      print("   âš ï¸ å¤±è´¥: æ–‡ä»¶è¿‡å°")
                      if os.path.exists(save_path): os.remove(save_path)
              except Exception as e:
                  print(f"   âŒ ä¸‹è½½å¼‚å¸¸: {e}")

          print(f"\nğŸ‰ ä»»åŠ¡å®Œæˆï¼æˆåŠŸä¸‹è½½ {downloaded_count} / {total_files} ä¸ªæ–‡ä»¶ã€‚")
          if downloaded_count == 0:
              sys.exit(1)
          EOF
          
          python3 downloader.py

      - name: Create Zip for Release
        run: |
          cd output
          # æ‰“åŒ…æ‰€æœ‰ä¸‹è½½ä¸‹æ¥çš„ ipk
          zip -r ../passwall_packages_all_ipq60xx.zip .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-all-${{ github.run_number }}
          name: Build ${{ github.run_number }} (All Packages)
          body: |
            âœ… å·²ä» SourceForge å…¨é‡ä¸‹è½½æ‰€æœ‰ Passwall ä¾èµ–åŒ…ã€‚
            
            **ä¿¡æ¯æ‘˜è¦ï¼š**
            - æºï¼š`moetayuko/openwrt-passwall-build` (packages-21.02)
            - æ¶æ„ï¼š`aarch64_cortex-a53` (ipq60xx)
            - ç­–ç•¥ï¼šå…¨é‡ä¸‹è½½ (Download All)
            
            ğŸ“¦ **åŒ…å«äº† xray, sing-box, shadowsocks ç­‰æ‰€æœ‰ç›¸å…³ç»„ä»¶**
            è¯·ä¸‹è½½ zip åè§£å‹ï¼Œæ ¹æ®éœ€è¦é€‰æ‹©å®‰è£…ã€‚
          files: passwall_packages_all_ipq60xx.zip
