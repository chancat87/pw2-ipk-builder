name: Download Passwall2 IPKs (Strict Index Mode)

on:
  workflow_dispatch:

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install requests

      - name: Run Downloader
        run: |
          mkdir -p output
          
          # åˆ›å»º Python è„šæœ¬
          cat << 'EOF' > downloader.py
          import requests
          import os
          import sys
          import gzip
          import io

          # =================é…ç½®åŒºåŸŸ=================
          # ä½ çš„ç›®æ ‡åœ°å€ (æ³¨æ„ï¼šè¿™æ˜¯ä¸‹è½½ä¸“ç”¨çš„ API åŸŸåï¼Œä¸æ˜¯ç½‘é¡µæµè§ˆåŸŸå)
          # è·¯å¾„å¯¹åº”ï¼šreleases/packages-21.02/aarch64_cortex-a53/passwall_packages
          BASE_URL = "https://downloads.sourceforge.net/project/openwrt-passwall-build/releases/packages-21.02/aarch64_cortex-a53/passwall_packages"
          
          # ä¼ªè£… Headerï¼Œé˜²æ­¢è¢«å½“æˆè„šæœ¬æ‹¦æˆª
          HEADERS = {
              'User-Agent': 'Wget/1.21.2 (linux-gnu)',
              'Accept': '*/*'
          }
          # ===========================================

          def get_index_content(url):
              print(f"æ­£åœ¨è·å–ç´¢å¼•: {url}")
              try:
                  r = requests.get(url, headers=HEADERS, timeout=30, allow_redirects=True)
                  if r.status_code == 404:
                      return None
                  r.raise_for_status()
                  return r.content
              except Exception as e:
                  print(f"è·å–å¤±è´¥: {e}")
                  return None

          # 1. ä¸‹è½½ Packages ç´¢å¼•æ–‡ä»¶
          # ä¼˜å…ˆå°è¯•çº¯æ–‡æœ¬ï¼Œå¦‚æœä¸å­˜åœ¨å°è¯• .gz
          content = get_index_content(f"{BASE_URL}/Packages")
          
          if not content:
              print("å°è¯•ä¸‹è½½ Packages.gz ...")
              gz_content = get_index_content(f"{BASE_URL}/Packages.gz")
              if gz_content:
                  try:
                      content = gzip.decompress(gz_content)
                  except:
                      print("è§£å‹ Packages.gz å¤±è´¥")
                      sys.exit(1)
          
          if not content:
              print("âŒ ä¸¥é‡é”™è¯¯ï¼šæ— æ³•è·å– Packages ç´¢å¼•æ–‡ä»¶ã€‚è¯·ç¡®è®¤æ¶æ„è·¯å¾„æ˜¯å¦æ­£ç¡®ã€‚")
              sys.exit(1)

          text_content = content.decode('utf-8', errors='ignore')

          # æ£€æŸ¥æ˜¯å¦è¯¯ä¸‹è½½äº† SourceForge çš„ HTML é”™è¯¯é¡µ
          if "<html" in text_content.lower() and "doctype" in text_content.lower():
              print("âŒ é”™è¯¯ï¼šè·å–åˆ°çš„æ˜¯ HTML é¡µé¢è€Œä¸æ˜¯ç´¢å¼•ã€‚è¯´æ˜è·¯å¾„é”™è¯¯æˆ–è¢«æ‹¦æˆªã€‚")
              print("è¿”å›å†…å®¹æ‘˜è¦:", text_content[:200])
              sys.exit(1)

          print("âœ… ç´¢å¼•è·å–æˆåŠŸï¼Œè§£æä¸­...")

          # 2. è§£æç´¢å¼• (æ„å»º Package -> Filename æ˜ å°„)
          pkg_map = {}
          current_pkg = None
          
          for line in text_content.splitlines():
              line = line.strip()
              if line.startswith("Package:"):
                  current_pkg = line.split(":", 1)[1].strip()
              elif line.startswith("Filename:") and current_pkg:
                  filename = line.split(":", 1)[1].strip()
                  pkg_map[current_pkg] = filename
                  current_pkg = None
          
          print(f"ğŸ“Š ç´¢å¼•åŒ…å« {len(pkg_map)} ä¸ªè½¯ä»¶åŒ…ã€‚")

          # 3. è¯»å–ç”¨æˆ·æ¸…å•
          if not os.path.exists("packages.txt"):
              print("âŒ æ‰¾ä¸åˆ° packages.txt")
              sys.exit(1)

          with open("packages.txt", "r") as f:
              targets = [line.strip() for line in f if line.strip() and not line.startswith("#")]

          # 4. åŒ¹é…å¹¶ä¸‹è½½
          downloaded_count = 0
          
          for target in targets:
              print(f"\nğŸ” å¯»æ‰¾: {target}")
              
              # ç­–ç•¥ A: ç²¾ç¡®åŒ¹é…åŒ…å
              filename = pkg_map.get(target)
              
              # ç­–ç•¥ B: å¦‚æœç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•åœ¨æ‰€æœ‰æ–‡ä»¶åä¸­æœç´¢
              if not filename:
                  # æ¯”å¦‚ target æ˜¯ shadowsocks-rust-sslocalï¼Œä½†æºé‡Œæ–‡ä»¶åå« shadowsocks-rust_...ipk
                  # æˆ‘ä»¬æœç´¢åŒ…å« target å­—ç¬¦ä¸²çš„æ–‡ä»¶å
                  candidates = [fname for pname, fname in pkg_map.items() if target in fname or target in pname]
                  if candidates:
                      # å–æœ€çŸ­çš„é€šå¸¸æ˜¯ä¸»åŒ…
                      candidates.sort(key=len)
                      filename = candidates[0]
                      print(f"   (æ¨¡ç³ŠåŒ¹é…æˆåŠŸ: {filename})")

              if filename:
                  print(f"   âœ… é”å®šæ–‡ä»¶: {filename}")
                  file_url = f"{BASE_URL}/{filename}"
                  save_path = f"output/{filename}"
                  
                  if os.path.exists(save_path):
                      print("      æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚")
                      continue

                  try:
                      print("      â¬‡ï¸ ä¸‹è½½ä¸­...")
                      # stream=True é¿å…å¤§æ–‡ä»¶å æ»¡å†…å­˜
                      with requests.get(file_url, headers=HEADERS, stream=True, timeout=60) as r:
                          r.raise_for_status()
                          with open(save_path, 'wb') as f:
                              for chunk in r.iter_content(chunk_size=8192):
                                  f.write(chunk)
                      
                      if os.path.getsize(save_path) > 1024:
                          print("      ğŸ†— ä¸‹è½½å®Œæˆ")
                          downloaded_count += 1
                      else:
                          print("      âš ï¸ æ–‡ä»¶è¿‡å°ï¼Œå¯èƒ½ä¸‹è½½å¤±è´¥")
                  except Exception as e:
                      print(f"      âŒ ä¸‹è½½å‡ºé”™: {e}")
              else:
                  print(f"   âš ï¸ æºä¸­æœªæ‰¾åˆ°: {target}")

          print(f"\nğŸ‰ ä»»åŠ¡ç»“æŸã€‚å…±ä¸‹è½½ {downloaded_count} ä¸ªæ–‡ä»¶ã€‚")
          if downloaded_count == 0:
              sys.exit(1)
          EOF
          
          # è¿è¡Œè„šæœ¬
          python3 downloader.py

      - name: Repackage
        run: |
          cd output
          zip -r ../passwall_ipk_final.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: passwall_ipk_final
          path: passwall_ipk_final.zip
